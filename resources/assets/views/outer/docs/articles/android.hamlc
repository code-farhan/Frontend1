- @children = []
- @title = 'Test Android applications'
- @lastUpdated = "July 29, 2014"

%p
  CircleCI supports testing Android applications. The SDK is
  already installed on the VM at

  %code
    \/usr\/local\/android-sdk-linux

%p
  To save space, we don't download
  every android version, so you'll need to specify the versions
  you use:

%pre
  %code.no-highlight<>
    :preserve
      dependencies:
        pre:
          \- echo y | android update sdk --no-ui --filter "android-18"
%p
  Note that if you need extended SDK components, such as build-tools, you'll
  also need to install those separately. For example:

%pre
  %code.no-highlight<>
    :preserve
      dependencies:
        pre:
          \- echo y | android update sdk --no-ui --filter "build-tools-20.0.0"
%h3#caching Caching Android SDK components

%p
  Installing SDK components can be expensive if you do it every time, so to speed
  up your builds, it is wise to copy
  the Android SDK to your home directory and add it to the set of cached directories.
  Also, we want to have <code>ANDROID_HOME</code> point to this new location.

%p
  To accomplish this, put something like the following in your <code>circle.yml</code>:

%pre
  %code.no-highlight<>
  :preserve
    machine:
      environment:
        ANDROID_HOME: /home/ubuntu/android
    dependencies:
      cache_directories:
        \- ~/.android
        \- ~/android
      override:
        \- ./install-dependencies.sh
%p
  This references the <code>install-dependencies.sh</code>
  script. This is a script that you should write that installs
  any Android dependencies, creates any test AVDs that you'll need, etc.
  It should only do this once, so it should have a check to see
  if the cached directories already have all of your dependencies.

%p
  For example, here is a basic <code>install-dependencies.sh</code>
  that installs <code>android-18</code>
  and some common tools. It also installs the x86 emulator image
  and builds an AVD called <code>testing</code>.
  (Note that if you ever change this file, you should clear your CircleCI
  cache.)

%pre
  :preserve

    #!/bin/bash

    # Fix the CircleCI path
    export PATH="$ANDROID_HOME/platform-tools:$ANDROID_HOME/tools:$PATH"

    DEPS="$ANDROID_HOME/installed-dependencies"

    if [ ! -e $DEPS ]; then
      cp -r /usr/local/android-sdk-linux $ANDROID_HOME &&
      echo y | android update sdk -u -a -t android-18 &&
      echo y | android update sdk -u -a -t platform-tools &&
      echo y | android update sdk -u -a -t build-tools-20.0.0 &&
      echo y | android update sdk -u -a -t sys-img-x86-android-18 &&
      echo y | android update sdk -u -a -t addon-google_apis-google-18 &&
      echo n | android create avd -n testing -f -t android-18 &&
      touch $DEPS
    fi
%h3#emulator Starting the Android emulator

%p
  For your actual tests, the first thing you should do is start up
  the emulator, as this usually takes several minutes, sadly.

%p
  It's best if you can separate your actual build from installing it and
  running tests on the emulator. If at all possible, start the build, and
  then you MUST wait for the emulator to finish booting before
  installing the APK and running your tests.

%p
  To wait for the emulator to boot, you need to wait for the
  <code>init.svc.bootanim</code> property to be set to
  <code>stopped</code>.

%p
  Here's an example script for that, <code>wait.sh</code>:

%pre
  :preserve

    #!/bin/bash

    export PATH="$ANDROID_HOME/platform-tools:$ANDROID_HOME/tools:$PATH"

    while true; do
      BOOTUP=$(adb shell getprop init.svc.bootanim | grep -oe '[a-z]\\+')
      if [[ "$BOOTUP" = "stopped" ]]; then
        break
      fi

      echo "Got: '$BOOTUP', waiting for 'stopped'"
      sleep 5
    done
%p
  Then, you need to boot up your emulator (in the background), start your build, wait for your
  emulator to finish booting, and then run your tests.
  In your <code>circle.yml</code> file, it will look something like

%pre
  %code.no-highlight<>
  :preserve
    test:
      override:
      \- $ANDROID_HOME/tools/emulator -avd testing -no-window -no-boot-anim -no-audio:
          background: true
      \- # start your build here
      \- ./wait.sh
      \- # install your APK
      \- # run your tests
%h3#testing Running your tests

%p
  The standard way to run tests in the Android emulator is with something like

%pre
  :preserve

    adb logcat &
    adb wait-for-device
    adb shell am instrument -w com.myapp.test/android.test.InstrumentationTestRunner

%p
  Unfortunately, this always succeeds, even if the tests fail.
  (There's a known bug that <code>adb shell</code> doesn't set its exit
  code to reflect the command that was run.
  See <a href="https://code.google.com/p/android/issues/detail?id=3254">Android issue 3254</a>.)

%p
  The only way around this is to parse your test output in a script
  and check to see if your tests passed.
  For example, if the tests pass, there should be a line that looks like
  <code>OK (15 tests)</code>.

%p
  Here's an example bash script that uses Python to look for that pattern,
  and exits with code 0 (success) if the success line is found, and otherwise
  with code 1 (error).

%pre
  :preserve

    #!/bin/bash

    export PATH="$ANDROID_HOME/platform-tools:$ANDROID_HOME/tools:$PATH"

    pushd YourTestApp

    # clear the logs
    adb logcat -c

    # run tests and check output
    python - << END
    import re
    import subprocess as sp
    import sys
    import threading
    import time

    done = False

    def update():
      # prevent CircleCI from killing the process for inactivity
      while not done:
        time.sleep(5)
        print "Running..."

    t = threading.Thread(target=update)
    t.dameon = True
    t.start()

    def run():
      sp.Popen(['adb', 'wait-for-device']).communicate()
      p = sp.Popen('adb shell am instrument -w com.myapp.test/android.test.InstrumentationTestRunner',
                   shell=True, stdout=sp.PIPE, stderr=sp.PIPE, stdin=sp.PIPE)
      return p.communicate()

    success = re.compile(r'OK \\(\\d+ tests\\)')
    stdout, stderr = run()

    done = True
    print stderr
    print stdout

    if success.search(stderr + stdout):
      sys.exit(0)
    else:
      sys.exit(1) # make sure we fail if the test failed
    END

    RETVAL=$?

    # dump the logs
    adb logcat -d

    popd
    exit $RETVAL

%hr

%p
  Please don't hesitate to
  != HAML['contact_us']()
  if you have any questions at all about how to best test Android on
  CircleCI.
